{"version":3,"names":[],"sources":["App.svelte"],"sourcesContent":["<script>\n  import { init } from 'dc-extensions-sdk';\n  import { fly } from 'svelte/transition';\n  import { offsetMinutesToString, pad } from './utils';\n  import Calendar from './components/Calendar.svelte';\n  import Clock from './components/Clock.svelte';\n  const now = new Date();\n  let date = nowDate();\n  let time = nowTime();\n  let editingDate = false;\n  let editingTime = false;\n  let type = 'string';\n  let format = 'date-time';\n  let showDate = true;\n  let showTime = true;\n  let unixMode = false;\n  let active = false;\n  let sdk;\n\n  (async () => {\n    try {\n      sdk = await init();\n      sdk.frame.startAutoResizer();\n      unixMode = sdk.params.installation.unix || sdk.params.instance.unix;\n      type = sdk.field.schema.type;\n      setState(sdk.field.schema.format);\n      const value = await sdk.field.getValue();\n      if (value === undefined) {\n        setDefaults();\n      } else {\n        active = true;\n      }\n      if (type === 'string') {\n        processStringInput(value);\n      } else if (type === 'number') {\n        processNumberInput(value);\n      }\n    } catch {}\n  })();\n\n  function setDefaults() {\n    switch (format) {\n      case 'date':\n        time = '00:00:00';\n        break;\n      case 'time':\n        date = '1970-01-01';\n        break;\n    }\n  }\n  function nowDate() {\n    return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(\n      now.getDate()\n    )}`;\n  }\n\n  function nowTime() {\n    return `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(\n      now.getSeconds()\n    )}`;\n  }\n\n  function processStringInput(input) {\n    if (!input) {\n      return;\n    }\n    switch (format) {\n      case 'date-time':\n        [date, time] = input.split('T');\n        break;\n      case 'date':\n        date = input;\n        break;\n      case 'time':\n        time = input;\n        break;\n    }\n    time = time.substr(0, 8);\n  }\n\n  function getNegativeLocalOffset() {\n    return 0 - getLocalOffset();\n  }\n\n  function getLocalOffset() {\n    return new Date(dateString(date, time)).getTimezoneOffset();\n  }\n\n  function processNumberInput(input) {\n    if (input === undefined || input === null || isNaN(input)) {\n      return;\n    }\n    let stamp = unixMode ? input * 1000 : input;\n    let d = new Date(stamp);\n    let offset = d.getTimezoneOffset();\n    time = calculateTime(d, offset);\n    date =\n      pad(d.getFullYear()) +\n      '-' +\n      pad(d.getMonth() + 1) +\n      '-' +\n      pad(d.getDate());\n  }\n\n  function calculateTime(d, offset) {\n    const offsetInHours = Math.trunc(offset / 60);\n    const remainingOffset = offset % 60;\n    let offsetHours = d.getHours() + offsetInHours;\n    let offsetMinutes = d.getMinutes() + remainingOffset;\n    if (offsetMinutes < 0) {\n      offsetHours--;\n      offsetMinutes = 60 + offsetMinutes;\n    } else if (offsetMinutes > 59) {\n      offsetHours++;\n      offsetMinutes = offsetMinutes % 60;\n    }\n    if (offsetHours < 0) {\n      d.setDate(d.getDate() - 1);\n      offsetHours = 24 + offsetHours;\n    } else if (offsetHours > 23) {\n      d.setDate(d.getDate() + 1);\n      offsetHours = offsetHours % 24;\n    }\n    return `${pad(offsetHours)}:${pad(offsetMinutes)}:${pad(d.getSeconds())}`;\n  }\n\n  function setState(f) {\n    if (!f) {\n      return;\n    }\n    if (f == 'time') {\n      format = f;\n      showDate = false;\n    } else if (f == 'date') {\n      format = f;\n      showTime = false;\n    }\n  }\n\n  function processNumberOutput() {\n    let d = new Date(dateString(date, time));\n    return unixMode ? d.getTime() / 1000 : d.getTime();\n  }\n\n  function dateString(d, t, offset) {\n    let ds = '';\n    if (offset !== undefined) {\n      ds = d + 'T' + t + '.000' + offset;\n    } else {\n      ds = d + 'T' + t + '.000Z';\n    }\n    return ds;\n  }\n\n  function processStringOutput() {\n    switch (format) {\n      case 'date-time':\n        return dateString(\n          date,\n          time,\n          offsetMinutesToString(getNegativeLocalOffset())\n        );\n      case 'date':\n        return date;\n      case 'time':\n        return time + '.000Z';\n    }\n  }\n  function update() {\n    let val;\n    if (type === 'string') {\n      val = processStringOutput();\n    } else if (type === 'number') {\n      val = processNumberOutput();\n    }\n    active = true;\n    if (sdk && val !== undefined) {\n      sdk.field.setValue(val);\n    }\n  }\n\n  function toggle(component) {\n    if (component === 'date') {\n      if (editingDate) {\n        editingDate = false;\n      } else {\n        editingDate = true;\n        editingTime = false;\n      }\n    }\n    if (component === 'time') {\n      if (editingTime) {\n        editingTime = false;\n      } else {\n        editingTime = true;\n        editingDate = false;\n      }\n    }\n  }\n</script>\n\n<main>\n  {#if sdk && sdk.field && sdk.field.schema && sdk.field.schema.title}\n    <div class=\"label\">\n      <p>{sdk.field.schema.title}:</p>\n    </div>\n  {/if}\n  {#if showDate}\n    <div class=\"date\" on:click={() => toggle('date')}>\n      <img src=\"./icons/calendar.svg\" alt=\"calendar icon\" />\n      <p class={active ? 'active' : ''}>\n        {new Date(\n          dateString(\n            date,\n            time,\n            offsetMinutesToString(getNegativeLocalOffset())\n          )\n        ).toLocaleDateString()}\n      </p>\n    </div>\n  {/if}\n  {#if showTime}\n    <div class=\"time\" on:click={() => toggle('time')}>\n      <img src=\"./icons/clock.svg\" alt=\"calendar icon\" />\n      <p class={active ? 'active' : ''}>\n        {new Date(\n          dateString(\n            date,\n            time,\n            offsetMinutesToString(getNegativeLocalOffset())\n          )\n        ).toLocaleTimeString()}\n      </p>\n    </div>\n  {/if}\n  <div class=\"clear\" />\n  {#if editingDate}\n    <div class=\"editor\" in:fly={{ x: -500, duration: 500 }}>\n      <Calendar\n        {date}\n        on:hide={() => (editingDate = false)}\n        on:update={(d) => (date = d.detail) && update()}\n      />\n    </div>\n  {/if}\n  {#if editingTime}\n    <div class=\"editor\" in:fly={{ x: -500, duration: 500 }}>\n      <Clock\n        {time}\n        on:hide={() => (editingTime = false)}\n        on:update={(d) => (time = d.detail) && update()}\n      />\n    </div>\n  {/if}\n  <div class=\"clear\" />\n</main>\n\n<style>\n  img {\n    height: 2em;\n  }\n\n  p {\n    text-decoration: underline;\n    height: 2em;\n    line-height: 2em;\n    padding: 0;\n    margin: 0;\n  }\n\n  img {\n    padding-right: 0.25em;\n  }\n\n  img,\n  p {\n    float: left;\n  }\n\n  .date,\n  .time,\n  .label {\n    display: inline-block;\n    margin: 0.25em;\n    cursor: pointer;\n  }\n\n  .date p,\n  .time p {\n    color: #999;\n  }\n\n  p.active {\n    color: #333;\n  }\n  .label p {\n    text-decoration: none;\n    cursor: default;\n  }\n\n  .clear {\n    clear: both;\n  }\n\n  main {\n    overflow: hidden;\n  }\n</style>\n"],"mappings":"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"}